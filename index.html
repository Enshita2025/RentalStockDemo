<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>車両割り当て（社員用）</title>
  <style>
    :root{
      --bg:#0d8a1e; --bg-dark:#066612;
      --panel:#f0f7f1; --panel-2:#e7ffe9;
      --accent:#1877ff;
      --tab-k:#3ecb54; --tab-n:#1c7ed6; --tab-m:#f59f00; --tab-b:#7b2cbf;
      --chip-pending-bar:#f5a8c3; --chip-assigned:#ffe9c6; --chip-proposed:#ffd39b;
      --grid-border:#9ad09e; --text:#1a1a1a; --muted:#666;
      --btn:#1f6feb; --btn-danger:#ff4d4f; --btn-text:#fff;
      --row-h:38px; --head-h:40px;
    }
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;color:var(--text)}
    header{padding:12px 16px;border-bottom:1px solid #000;background:#fafafa}
    header h1{margin:0;font-size:20px}

    .toolbar{position:relative;padding-top:38px;background:var(--bg);display:flex;align-items:center;gap:8px}
    .tabs{display:flex;gap:0;position:absolute;top:0;left:0;z-index:2;margin:0}
    .tab{border:1px solid #ccc;border-bottom:none;background:#fff;color:#333;padding:8px 24px;border-radius:8px 8px 0 0;font-weight:700;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-right:2px}
    .tab[data-type="k"]{background:var(--tab-k)} .tab[data-type="n"]{background:var(--tab-n)}
    .tab[data-type="m"]{background:var(--tab-m)} .tab[data-type="b"]{background:var(--tab-b)}
    .toolbar .spacer{flex:1}
    .nav-btn{border:2px solid #fff;background:transparent;color:#fff;border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer}
    .actions{display:flex;gap:8px;justify-content:flex-end;background:var(--bg);padding:8px 0;flex:1}
    .btn{border:none;border-radius:8px;padding:8px 14px;font-weight:700;color:var(--btn-text);cursor:pointer}
    .btn-primary{background:var(--btn)} .btn-danger{background:var(--btn-danger)}

    .board{background:var(--bg);padding:10px}
    .matrix{background:var(--panel);margin:10px 0;padding:10px}

    /* 共通グリッド（親に上・左だけ 1px 線） */
    .grid{
      display:grid;
      grid-template-columns:80px repeat(14,1fr);
      gap:0;
      background:var(--panel-2);
      position:relative;
      border-top:1px solid var(--grid-border);
      border-left:1px solid var(--grid-border);
    }

    /* ヘッダーセル：右・下だけ。先頭ヘッダーは1列目固定 */
    .col-head{
      padding:6px 4px;background:#444;color:#fff;
      font-weight:700;text-align:center;font-size:15px;height:var(--head-h);
      display:flex;align-items:center;justify-content:center;
      border-right:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
    }
    .col-head:first-child{
      background:#fff;color:#333;
      grid-column:1 / 2;
      grid-row:1 / 2;
    }
    .col-day{grid-column:span 2}

    /* ラベル列：白／右・下のみ。必ず1列目に固定 */
    .row-label{
      background:#fff;color:#b04b6b;font-weight:700;display:flex;align-items:center;justify-content:center;
      border-right:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
      grid-column:1 / 2;
    }
    .veh-label{
      background:#eef7ff;font-weight:700;display:flex;align-items:center;justify-content:center;
      border-right:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
      grid-column:1 / 2;
    }

    /* 本体セル：右・下のみ（二重線回避） */
    .cell{
      position:relative;
      height:var(--row-h);
      background:#fff;
      border-right:1px solid var(--grid-border);
      border-bottom:1px solid var(--grid-border);
    }

    /* ピンク（未割当）= 1要素でセルをまたぐ（グリッド座標で配置） */
    .pending-btn{
      border:1px solid #e07aa3;background:var(--chip-pending-bar);border-radius:0;
      height:100%;width:100%;display:flex;align-items:center;justify-content:center;
      font-size:12px;line-height:1.1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
      cursor:pointer;position:relative;z-index:3;
    }
    .pending-btn:focus-visible{outline:3px solid #1877ff;outline-offset:2px}
    .pending-btn.selected{box-shadow:inset 0 0 0 2px #fff, 0 0 0 3px #1877ff}

    /* ベージュ（確定）= セル内絶対配置 */
    .bar.beige{
      position:absolute; inset:0; z-index:1;
      background:var(--chip-assigned); border:1px solid #e0c091; border-radius:0;
      display:flex; align-items:center; justify-content:center; font-size:12px;
    }

    /* オレンジ（仮割当）= セル内絶対配置 */
    .assign-btn{
      position:absolute; inset:0; z-index:2;
      border:1px solid #f0a44a; background:var(--chip-proposed); border-radius:0;
      display:flex; align-items:center; justify-content:center;
      font-size:12px; line-height:1.1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer;
    }

    footer{padding:12px 16px;color:var(--muted)}
    @media (max-width:960px){.grid{grid-template-columns:64px repeat(14,1fr)}}
  </style>
</head>
<body>
  <header><h1>車両割り当て（社員用ページ）</h1></header>

  <div class="toolbar">
    <div class="tabs">
      <button class="tab" data-type="k">軽自動車</button>
      <button class="tab" data-type="n">小型普通</button>
      <button class="tab" data-type="m">ミニバン</button>
      <button class="tab" data-type="b">BOXY</button>
    </div>
    <div class="spacer"></div>
    <button class="nav-btn" id="prevWeek" title="前の週へ">◀</button>
    <button class="nav-btn" id="today" title="今日">⟳</button>
    <button class="nav-btn" id="nextWeek" title="次の週へ">▶</button>
    <div class="actions">
      <button class="btn btn-primary" id="commit">更新確定</button>
      <button class="btn btn-danger" id="cancel">取り消し</button>
      <button class="nav-btn" id="clearSelection">選択解除</button>
    </div>
  </div>

  <div class="board">
    <section class="matrix">
      <div class="grid" id="pendingGrid"></div>
    </section>
    <section class="matrix">
      <div class="grid" id="vehicleGrid"></div>
    </section>
  </div>

  <footer>
    操作：上段ピンクをクリック → 下段の車両行（セル or 行ラベル）クリックで、同レンジにオレンジ（仮割当）を配置。  
    「更新確定」＝オレンジ→ベージュ確定、「取り消し」＝オレンジ削除。未選択時は一括処理。
  </footer>

  <script>
    // ===== デモデータ =====
    const startDate = new Date('2025-08-18T00:00:00+09:00');
    const pendingTracks = 6; // 上段はヘッダー除いて6行固定

    const pendingSamples = [
      { id:'p1', name:'田中１', start:'2025-08-18T09:00:00+09:00', end:'2025-08-19T12:00:00+09:00' },
      { id:'p2', name:'佐藤',   start:'2025-08-19T09:00:00+09:00', end:'2025-08-20T12:00:00+09:00' },
      { id:'p3', name:'高木',   start:'2025-08-20T14:00:00+09:00', end:'2025-08-21T15:00:00+09:00' },
      { id:'p4', name:'栗山',   start:'2025-08-19T09:00:00+09:00', end:'2025-08-19T19:00:00+09:00' },
      { id:'p5', name:'田中',   start:'2025-08-22T09:00:00+09:00', end:'2025-08-22T15:00:00+09:00' },
      { id:'p6', name:'米山',   start:'2025-08-24T12:00:00+09:00', end:'2025-08-24T19:00:00+09:00' }
    ];
    const vehicles = [
      { name:'緑EK' }, { name:'水カブ' }, { name:'奈モコ' },
      { name:'青モコ' }, { name:'紫ソR' }, { name:'銀トツ' }
    ];
    const assigned = [
      { vehicle:'緑EK',  who:'青木', start:'2025-08-18T09:00:00+09:00', end:'2025-08-18T19:00:00+09:00' },
      { vehicle:'水カブ', who:'横山', start:'2025-08-18T13:00:00+09:00', end:'2025-08-18T19:00:00+09:00' },
      { vehicle:'緑EK',  who:'青山', start:'2025-08-20T09:00:00+09:00', end:'2025-08-20T19:00:00+09:00' },
      { vehicle:'青モコ', who:'小林', start:'2025-08-22T09:00:00+09:00', end:'2025-08-22T19:00:00+09:00' },
      { vehicle:'紫ソR', who:'山田', start:'2025-08-21T09:00:00+09:00', end:'2025-08-21T15:00:00+09:00' },
      { vehicle:'銀トツ', who:'米山', start:'2025-08-23T15:00:00+09:00', end:'2025-08-23T19:00:00+09:00' }
    ];

    const days = ['8/18(月)','8/19(火)','8/20(水)','8/21(木)','8/22(金)','8/23(土)','8/24(日)'];
    const SLOTS_PER_WEEK = 14;               // 7日×AM/PM
    const HEADER_CELLS   = 1 + 7;            // ラベル1 + 日付7
    const ROW_STRIDE     = 1 + SLOTS_PER_WEEK; // ラベル1 + 14

    // ---- util ----
    function clampToWeek(s, e){
      const weekStart = new Date(startDate);
      const weekEnd = new Date(startDate); weekEnd.setDate(startDate.getDate()+7);
      if(e <= weekStart || s >= weekEnd) return null;
      return [new Date(Math.max(s, weekStart)), new Date(Math.min(e, weekEnd))];
    }
    function slotFromDate(d){
      const dayIndex = Math.floor((d - startDate)/86400000);
      const part = d.getHours() < 12 ? 0 : 1; // AM:0, PM:1
      return dayIndex*2 + part;
    }

    function createEmptyRows(container, rows, rowLabelClass, labelProvider){
      container.innerHTML = '';

      // ヘッダー行（grid-row:1 固定）
      const first = document.createElement('div');
      first.className='col-head';
      first.textContent='';
      first.style.gridColumn='1 / 2';
      first.style.gridRow='1 / 2';
      container.appendChild(first);

      days.forEach((d, i)=>{
        const el=document.createElement('div');
        el.className='col-head col-day';
        el.textContent=d;
        el.style.gridColumn = `${2 + i*2} / ${2 + i*2 + 2}`; // 2列分
        el.style.gridRow    = '1 / 2';
        container.appendChild(el);
      });

      // 本体行（各セル・ラベルに「明示的に」座標を与える）
      for(let r=0;r<rows;r++){
        const rowLine = 2 + r; // 2行目から本体

        const label=document.createElement('div');
        label.className=rowLabelClass;
        label.textContent=labelProvider ? labelProvider(r) : '';
        label.style.gridColumn='1 / 2';
        label.style.gridRow   =`${rowLine} / ${rowLine+1}`;
        if(rowLabelClass==='veh-label') label.dataset.vIndex=r;
        container.appendChild(label);

        for(let c=0;c<SLOTS_PER_WEEK;c++){
          const colStart = 2 + c;
          const cell=document.createElement('div');
          cell.className='cell';
          cell.dataset.row=r;
          cell.dataset.slot=c;
          cell.style.gridColumn = `${colStart} / ${colStart+1}`;
          cell.style.gridRow    = `${rowLine} / ${rowLine+1}`;
          container.appendChild(cell);
        }
      }
    }

    // ---- 上段：未割当（ピンク=1要素でスパン） ----
    let selectedRange = null; // {id,startSlot,endSlot,label}
    function renderPending(){
      const grid = document.getElementById('pendingGrid');
      createEmptyRows(grid, pendingTracks, 'row-label', (r)=> r===0 ? '未割当予約' : '');

      // 6件まで、各行に1つのピンクボタンを「スパン配置」
      pendingSamples.slice(0, pendingTracks).forEach((p, idx)=>{
        const s = new Date(p.start), e = new Date(p.end);
        const clamped = clampToWeek(s,e);
        if(!clamped) return;
        const [cs, ce] = clamped;

        const startSlot = slotFromDate(cs);
        const endSlot   = slotFromDate(ce);

        const startCol = 2 + startSlot;     // 1=ラベル列、2..15=スロット
        const endCol   = 2 + endSlot + 1;   // CSS grid の終端は+1
        const row      = 2 + idx;           // ヘッダーの次の行

        const btn = document.createElement('button');
        btn.type='button';
        btn.className='pending-btn';
        btn.textContent=p.name;
        btn.title = `${p.name}：${cs.toLocaleString()} ～ ${ce.toLocaleString()}`;
        btn.style.gridColumn = `${startCol} / ${endCol}`;
        btn.style.gridRow    = `${row} / ${row + 1}`;
        btn.dataset.user = p.id;

        btn.addEventListener('click', (ev)=>{
          grid.querySelectorAll('.pending-btn.selected').forEach(el=>el.classList.remove('selected'));
          btn.classList.add('selected');
          selectedRange = { id:p.id, startSlot, endSlot, label:p.name };
          ev.stopPropagation();
        });

        grid.appendChild(btn);
      });
    }

    // ---- 下段：車両（ベージュ確定 + クリックでオレンジ提案） ----
    function renderVehicles(){
      const grid = document.getElementById('vehicleGrid');
      createEmptyRows(grid, vehicles.length, 'veh-label', (r)=> vehicles[r]?.name || '');

      // 既存ベージュ（確定）
      assigned.forEach(a=>{
        const vIndex = vehicles.findIndex(v=>v.name===a.vehicle);
        if(vIndex<0) return;
        const s=new Date(a.start), e=new Date(a.end);
        const clamped = clampToWeek(s,e);
        if(!clamped) return;
        const [cs, ce] = clamped;
        const startSlot = slotFromDate(cs);
        const endSlot   = slotFromDate(ce);
        fillRangeWithBar(grid, vIndex, startSlot, endSlot, a.who, 'beige');
      });

      // クリックでオレンジ提案（1ユーザー=常に1件）
      grid.addEventListener('click', (ev)=>{
        if(!selectedRange) return;
        let vIndex = null;

        const labelEl = ev.target.closest('.veh-label');
        if(labelEl) vIndex = parseInt(labelEl.dataset.vIndex, 10);

        if(vIndex===null || Number.isNaN(vIndex)){
          const cellEl = ev.target.closest('.cell');
          if(cellEl) vIndex = parseInt(cellEl.dataset.row, 10);
        }
        if(vIndex===null || Number.isNaN(vIndex)) return;

        // 同ユーザーの既存オレンジを全て削除 → 新規1件だけ配置
        removeAllUserProposals(grid, selectedRange.id);
        fillRangeWithButton(grid, vIndex, selectedRange.startSlot, selectedRange.endSlot, selectedRange.label, 'assign-btn', selectedRange.id);
      });
    }

    // ---- 共通：セル範囲にベージュ（div）を敷く ----
    const S = { HEADER_CELLS, ROW_STRIDE };
    function fillRangeWithBar(grid, vIndex, startSlot, endSlot, label, colorClass){
      const startCellIndex = S.HEADER_CELLS + vIndex*S.ROW_STRIDE + 1 + startSlot;
      const endCellIndex   = S.HEADER_CELLS + vIndex*S.ROW_STRIDE + 1 + endSlot;
      for(let i=startCellIndex;i<=endCellIndex;i++){
        const cell = grid.children[i];
        if(!cell || cell.className!=='cell') continue;
        const bar = document.createElement('div');
        bar.className = `bar ${colorClass}`;
        if(i===startCellIndex) bar.textContent = label;
        cell.appendChild(bar);
      }
    }

    // ---- 共通：セル範囲にオレンジ（button）を敷く（ユーザーIDを付与） ----
    function fillRangeWithButton(grid, vIndex, startSlot, endSlot, label, btnClass, userId){
      const key = `${vIndex}-${startSlot}-${endSlot}`;
      const startCellIndex = S.HEADER_CELLS + vIndex*S.ROW_STRIDE + 1 + startSlot;
      const endCellIndex   = S.HEADER_CELLS + vIndex*S.ROW_STRIDE + 1 + endSlot;

      for(let i=startCellIndex;i<=endCellIndex;i++){
        const cell = grid.children[i];
        if(!cell || cell.className!=='cell') continue;
        const btn = document.createElement('button');
        btn.type='button';
        btn.className = btnClass;
        btn.dataset.key = key;
        if(userId) btn.dataset.user = userId;
        if(i===startCellIndex) btn.textContent = label;
        cell.appendChild(btn);
      }
    }

    // ---- オレンジ取得/削除ユーティリティ ----
    function removeAllUserProposals(grid, userId){
      grid.querySelectorAll(`.assign-btn[data-user="${userId}"]`).forEach(n=>n.remove());
    }
    function getProposalKeysByUser(grid, userId){
      const nodes = grid.querySelectorAll(`.assign-btn[data-user="${userId}"]`);
      const keys = new Set();
      nodes.forEach(n=>keys.add(n.dataset.key));
      return Array.from(keys);
    }
    function getAllProposalKeys(grid){
      const nodes = grid.querySelectorAll(`.assign-btn`);
      const keys = new Set();
      nodes.forEach(n=>keys.add(n.dataset.key));
      return Array.from(keys);
    }
    function getLabelForKey(grid, key){
      const n = grid.querySelector(`.assign-btn[data-key="${key}"]`);
      return n ? (n.textContent || '') : '';
    }
    function parseKey(key){
      const [v,start,end] = key.split('-').map(Number);
      return { vIndex:v, startSlot:start, endSlot:end };
    }

    // ---- ボタン挙動：確定 / 取り消し / 選択解除 ----
    document.getElementById('commit')?.addEventListener('click', ()=>{
      const grid = document.getElementById('vehicleGrid');

      const uid = selectedRange?.id || null;
      const keys = uid ? getProposalKeysByUser(grid, uid) : getAllProposalKeys(grid);
      if(keys.length === 0) return;

      keys.forEach(key=>{
        const { vIndex, startSlot, endSlot } = parseKey(key);
        const label = getLabelForKey(grid, key);
        grid.querySelectorAll(`.assign-btn[data-key="${key}"]`).forEach(n=>n.remove());
        fillRangeWithBar(grid, vIndex, startSlot, endSlot, label, 'beige');
      });

      if(uid){
        document.querySelectorAll(`#pendingGrid .pending-btn[data-user="${uid}"]`).forEach(n=>n.remove());
        selectedRange = null;
      }
    });

    document.getElementById('cancel')?.addEventListener('click', ()=>{
      const grid = document.getElementById('vehicleGrid');
      const uid = selectedRange?.id || null;
      if(uid){
        removeAllUserProposals(grid, uid);
      }else{
        grid.querySelectorAll(`.assign-btn`).forEach(n=>n.remove());
      }
    });

    document.getElementById('clearSelection')?.addEventListener('click', ()=>{
      selectedRange = null;
      document.querySelectorAll('.pending-btn.selected').forEach(el=>el.classList.remove('selected'));
    });

    // 初期化
    renderPending();
    renderVehicles();
  </script>
</body>
</html>
